# 游戏策划逆向整理文档 (Current Version)

> **文档说明**：本文档完全基于当前游戏版本（代码库真实状态）逆向生成。所有描述均代表当前实际实现的逻辑，不包含任何废弃设想或未实现的规划。

## 1. 游戏概述
本作是一款 **基于垂直三消机制的回合制策略 RPG**（类 Clash Quest 玩法）。
玩家需要在有限的兵力（卡组）耗尽前，通过策略性的消除指令控制单位攻击，通过关卡中的所有波次。

### 核心体验目标
*   **资源管理**：卡组数量有限，每一次消除都消耗兵力，玩家必须追求高性价比的输出。
*   **阵型构筑**：利用“连击”机制最大化伤害，同时通过消除调整阵型，使特定单位攻击到理想目标。

---

## 2. 玩家核心玩法循环 (Core Loop)

### 2.1 循环流程
1.  **玩家回合 (Player Turn)**
    *   **观察**：查看当前网格内的单位分布。
    *   **决策**：点击某个单位，触发 **连击 (Combo)**。
    *   **行动**：
        *   系统判定与点击单位相连（上下左右）的同类单位（最大 5 个）。
        *   连击单位获得伤害加成。
        *   单位按顺序（左->右，上->下）执行攻击或技能。
        *   行动后的单位直接 **死亡/消耗**，腾出网格空间。
    *   **重填 (Refill)**：
        *   上方单位下落填补空缺。
        *   若卡组有剩余，从顶部生成新单位填补空位（智能填充，尽量避免直接生成>5连）。
    *   **回合结束**：等待 500ms 进入敌方回合。

2.  **敌方回合 (Enemy Turn)**
    *   **Boss 行动**（若存在）：执行移动或特殊攻击。
    *   **杂兵行动**：
        *   系统从存活的非 Boss 敌人中**随机选取 1 个**。
        *   该单位有 **80%** 概率发动攻击。
        *   攻击结束后，回合交还给玩家。

3.  **胜负判定**
    *   **波次胜利**：当前波次所有敌人被消灭。若为最后一波，则游戏胜利。
    *   **游戏失败**：玩家场上无单位 且 卡组（Deck）耗尽（推测，需终局逻辑确认）。

---

## 3. 系统与功能模块拆解

### 3.1 战斗单位系统 (Unit System)
所有单位共用基础属性：`HP`（生命）, `ATK`（攻击）, `DEF`（防御 - 减免受到的伤害）。

#### **玩家单位 (Player Units)**
| 单位名称 | 类型 | 索敌逻辑 | 攻击/技能效果 |
| :--- | :--- | :--- | :--- |
| **战士 (Warrior)** | 近战 | 1. 同列最前方敌人 <br> 2. 邻列最前方敌人 | 单体物理伤害。 |
| **弓手 (Archer)** | 远程 | （同战士） | 单体远程伤害（带投射物动画）。 |
| **法师 (Mage)** | 远程 | 距离最近的敌人 | **AOE 伤害**：以目标为基准，攻击 **2x2 区域**（目标+右+下+右下）。<br>注：攻击范围严格限制在敌方棋盘内。 |
| **骑士 (Knight)** | 近战 | **严格仅限同列** | **冲锋与穿透**：<br>1. 对同列最前方敌人造成 100% 伤害。<br>2. 对该敌人**正后方**单位造成 50% 穿透伤害。<br>3. 若同列无敌人，冲锋至底线并直接死亡（空大）。 |

#### **敌方单位 (Enemy Units)**
| 单位名称 | 行为特征 | 技能描述 |
| :--- | :--- | :--- |
| **哥布林 (Melee)** | 单体攻击 | 攻击同列最前方玩家。若同列无玩家，找邻列。 |
| **长矛手 (Ranged)** | 远程攻击 | 逻辑同哥布林，带投射物。 |
| **术士 (AoE Minion)** | AOE 攻击 | 锁定距离最近的玩家。造成 **2x2 区域** 伤害（同法师逻辑）。 |
| **Boss 1 (Col-Smasher)** | 移动 + 列伤 | **移动**：每回合左右移动。<br>**攻击**：随机选择其占据的两列之一，对该列玩家造成全体伤害。 |
| **Boss 2 (Area-Crusher)** | 瞬移 + 区域伤 | **瞬移**：每回合随机瞬移到合法 2x2 位置。<br>**攻击**：随机选取玩家棋盘一处 2x2 区域进行轰炸。 |

### 3.2 连击与伤害系统 (Combo System)
*   **连击判定**：
    *   算法：BFS 搜索相连同色块。
    *   **限制**：单次点击最多激活 **5 个** 单位。若相连超过 5 个，仅选取前 5 个（逻辑可能基于搜索顺序）。
*   **伤害加成**：
    *   公式：`FinalDamage = BaseAtk * (1 + (ChainLength - 1) * 0.2)`
    *   示例：
        *   1 个：100% 伤害
        *   3 个：140% 伤害
        *   5 个：180% 伤害

### 3.3 关卡与波次 (Level & Operations)
*   **配置结构**：
    *   定义棋盘列数（Cols，常见 3 或 4）。
    *   定义多波次（Waves）。每一波定义敌方行数、固定敌人位置、随机填充敌人类型与数量。
*   **卡组 (Deck)**：
    *   关卡开始时给予固定数量的单位（如 战士x12, 弓手x10...）。
    *   补充单位时扣除库存，库存为 0 则不再补充。

---

## 4. 规则与逻辑判定

### 4.1 核心规则细节
*   **防御机制**：伤害计算为 `Max(1, Damage - Defense)`。防御力直接减免伤害。
*   **单位消耗**：玩家单位攻击后**必须死亡**。无论是否击杀敌人，甚至无论是否命中目标（如骑士空冲），攻击动作结束后单位即从棋盘移除。
*   **空挥惩罚**：若玩家单位索敌失败（如近战单位前方无敌人且无法借位），单位会执行“消失”或“冲锋出界”动画并死亡，浪费一次行动。

### 4.2 隐性规则
*   **敌方行动频率**：敌方并非全员攻击。每回合（除 Boss 外）**仅有一名** 随机选中的杂兵会尝试攻击（概率 80%）。这极大降低了每回合的生存压力。
*   **智能填充 (Smart Spawn)**：玩家棋盘补充新单位时，系统会尝试避免生成导致“开局即连击数 > 5”的单位类型（简易防爆逻辑）。

---

## 5. 玩家决策结构

### 5.1 战术决策点
1.  **攒连击 vs 早消耗**：
    *   是现在消除 2 个单位打少量伤害，还是等待掉落凑齐 5 个打爆发？
    *   风险：等待过程可能导致关键单位被杀或卡组耗尽。
2.  **阵型调整**：
    *   利用消除“不需要”的列，让后排的关键输出（如骑士、法师）前移或对齐目标。
    *   示例：为了让骑士攻击到敌方 Boss，必须消除挡在骑士前面的战士。
3.  **AOE 最大化**：
    *   法师攻击目标的右下侧区域。玩家需通过消除，确立法师攻击时的首要目标（Distance Closest），从而最大化 AOE 覆盖。

---

## 6. 当前版本边界与缺口

### 6.1 明确不包含的内容
*   **无魔法/道具系统**：仅靠单位自身攻击。
*   **无单位成长**：属性在 Config 中写死，局内无升级。
*   **无撤回功能**：点击即行动。

### 6.2 待定/缺口
*   **终局判定 UI**：虽然代码有 Victory/Wave Clear 文字，但“失败”后的流程（如由 `checkGameOver` 触发的逻辑）尚未详细确认，可能仅是无法操作。
*   **动画并发**：目前玩家连击单位是**依次**行动（await 间隔），导致 5 连击时节奏较拖沓。

---

## 7. 当前版本整体总结

**当前版本特征**：
这是一个**高消耗、快节奏**的轻策略消除游戏。与传统三消 RPG（消除宝石攒能量）不同，本作中**单位即弹药**。
核心驱动力在于**最大化单次点击的伤害转化率**（Damage per Click）。由于卡组有限，玩家不能随意浪费小连击，必须尽可能凑出 4-5 连击或利用 AOE/穿透机制处理高价值目标。

敌方低频的攻击模式（单体轮询）给予了玩家充分的布局时间，强调“进攻规划”远大于“防守生存”。
