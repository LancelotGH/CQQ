# 实施计划 - 棋盘与关卡优化

## 目标
优化游戏，支持可变棋盘尺寸（3x3, 3x4），将视觉风格更新为红/蓝主题且无间隙，并增强关卡编辑器以支持波次特定的配置（棋盘大小、敌人位置、波次数量）。

## 需要用户审查
- [ ] 确认资源规格计算。

## 建议变更

### 1. 配置与资源 (`js/config.js`, `asset_specs.md`)
- **网格设置**: 将 `gridGap` 设置为 0。
- **棋盘间距**: 添加 `boardGap` 配置 (默认 10)，控制敌我棋盘垂直距离。
- **颜色**: 为玩家（蓝色）及敌人（红色）添加 `boardThemes`。
- **关卡结构更新**:
    - 在 Level 对象中添加 `playerRows`, `playerCols`。
    - 在 Wave 对象中添加 `enemyRows`。
    - 在 Wave 对象中添加 `placements` 数组用于固定位置（例如 `[{ type: 'goblin', r: 0, c: 1 }]`）。
- **资源规格**: 创建 `asset_specs.md` 详述棋盘尺寸：
    - 3x3: 210x210 px
    - 3x4: 210x280 px
    - 4x4: 280x280 px

### 2. 视觉效果 (`js/textureGenerator.js`, `js/game.js`)
- **纹理生成**:
    - 生成 4 种瓦片纹理：`tile_player_light`, `tile_player_dark` (蓝色调), `tile_enemy_light`, `tile_enemy_dark` (红色调)。
- **网格渲染**:
    - 更新 `drawGridBackground` 以接受“主题”参数。
    - 确保在波次变化时（如果敌方棋盘大小改变）重绘/更新背景。

### 3. 游戏逻辑 (`js/game.js`)
- **初始化**:
    - 从关卡配置读取 `playerRows`/`playerCols`。
    - 动态初始化 `playerGrid`。
- **波次生成**:
    - 从 Wave 条目读取 `enemyRows`。
    - 如果尺寸变化，重新初始化 `enemyGrid` 并重绘敌方棋盘背景。
    - 支持 **固定放置**:
        - 在 `spawnWave` 中，优先处理 `placements` 配置。
        - 剩余槽位根据 `counts` 随机填充（同以前）或完全手动配置。
- **棋盘交互**:
    - 将所有硬编码的 `4` 替换为 `this.playerRows`, `this.playerCols`, `this.enemyRows`。
    - 更新边界检查 (`r < rows`, `c < cols`)。
- **Bug 修复**:
    - **连携加成**: 在 `executePlayerCombo` 中实现伤害加成逻辑（Combo 越多伤害越高，例如 +10% 伤害/Combo）。

### 4. 新单位 Knight
- **新单位 Knight**:
    - **配置**: HP: 120, ATK: 30, Penetration: 50% (对后排伤害).
    - **逻辑**:
        - 索敌: 同列最近敌人 (`findTargetsFor` 已支持，需确认返回顺序).
        - 攻击: 冲锋动画 + 穿透伤害 (如果命中目标，检查目标后方是否存在单位，存在则造成 50% 伤害).
        - 无敌: 若同列无敌人，执行冲出屏幕动画并消失 (视为未命中/撤退).
    - **资源**: 加载 `assets/Knight.png`，若失败使用 TextureGenerator 生成临时纹理 (灰色/银色).

### 5. Mage/AoE 优化与弹道
- **弹道资源**:
    - Archer 使用 `assets/arrow.png` (40x15 px, 右向)。
- **Mage / AoE Minion 逻辑**:
    - **范围**: 2x2 格子。
    - **定位**: 以索敌目标为基础点 (Base Origin) 寻找 2x2 区域。
        - 确保 2x2 区域完全位于**对手**的棋盘内。
        - 如果目标在边缘，尝试调整 2x2 框的位置以包含目标且不越界 (或者严格按照 "目标为左上角" 并在越界时裁切/无效化? 用户说"以目标为基础点...寻找2x2"，且"必须在区域内"。最佳方案是：以目标为核心，尽量覆盖，但严格限制在 grid 范围内。通常是 `[r, c], [r, c+1], [r+1, c], [r+1, c+1]`，如果越界则忽略越界部分)。
    - **伤害**: 范围内所有单位受到一致伤害 (等于攻击者 ATK)。

## 验证计划

### 自动化测试
- 无（主要为视觉/游戏性变更）。

### 手动验证
1.  **修改关卡 1**: 设置关卡 1 使用 **3x3 玩家棋盘** 和 **混合波次**（波次 1：3x3 敌人，波次 2：3x4 敌人）。
2.  **视觉检查**:
    - 启动游戏。
    - 验证玩家棋盘为蓝色主题，无间隙。
    - 验证敌方棋盘为红色主题，无间隙。
    - 验证波次 1 敌方棋盘为 3x3。
    - 完成波次 1。
    - 验证波次 2 敌方棋盘变为 3x4。
3.  **放置检查**:
    - 配置波次 1 在 `(0,0)` 处有一个哥布林。
    - 重启并验证哥布林位于 `(0,0)`。
